machine:
  services:
    - docker

  pre:
#    - if [ ! -f "/home/ubuntu/rustup.sh" ]; then curl https://sh.rustup.rs -sSf > /home/ubuntu/rustup.sh && chmod ogu+x /home/ubuntu/rustup.sh && /home/ubuntu/rustup.sh -y ; fi
#    - chmod ogu+x /home/ubuntu/rustup.sh
#    - /home/ubuntu/rustup.sh -y
#    - echo "source $HOME/.cargo/env" >> /home/ubuntu/.bashrc
#    - rustup default nightly-2016-09-05
    - rm -f /home/ubuntu/.gitconfig
    - sudo service mysql stop

dependencies:
  pre:
    - >
      docker run
      --detach
      --name mysql
      --publish 3306:3306
      --env MYSQL_ALLOW_EMPTY_PASSWORD='yes'
      --env MYSQL_DATABASE=zero
      --env MYSQL_USER=agiluser
      --env MYSQL_PASSWORD=password123
      mysql:5.7.12 ; sleep 20

  override:
    - if [ ! -f "/home/ubuntu/rustup.sh" ]; then curl https://sh.rustup.rs -sSf > /home/ubuntu/rustup.sh && chmod ogu+x /home/ubuntu/rustup.sh && /home/ubuntu/rustup.sh -y ; fi
#    - chmod ogu+x /home/ubuntu/rustup.sh
#    - /home/ubuntu/rustup.sh -y
    - echo "source $HOME/.cargo/env" >> /home/ubuntu/.bashrc
    - rustup default nightly-2016-08-03
    - source /home/ubuntu/.cargo/env && rustup override set nightly-2016-08-03 && cargo build

  cache_directories:
    - "/home/ubuntu/rustup.sh"
    - "/home/ubuntu/.cargo"
    - "/home/ubuntu/.multirust"

test:
  override:
    - source /home/ubuntu/.cargo/env && rustup override set nightly-2016-08-03 && cargo test
    - /bin/bash scripts/circleci/test.sh
    - source /home/ubuntu/.cargo/env && rustup override set nightly-2016-08-03 && cargo doc

general:
  artifacts:
    - "/home/ubuntu/agildata-zero/target/doc/agildata_zero"

deployment:
  deploy:
    branch: [develop, master, feature-cci-deploy]
    commands:
      - /bin/bash scripts/circleci/deploy.sh

